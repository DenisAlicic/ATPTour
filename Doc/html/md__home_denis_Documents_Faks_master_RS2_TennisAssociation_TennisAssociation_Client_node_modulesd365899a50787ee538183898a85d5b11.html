<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tennis Association: @npmcli/metavuln-calculator</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Tennis Association
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle">
<div class="title">@npmcli/metavuln-calculator </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p class="">Calculate meta-vulnerabilities from package security advisories</p>
<p class="">This is a pretty low-level package to abstract out the parts of <a href="http://npm.im/@npmcli/arborist">@npmcli/arborist</a> that calculate metavulnerabilities from security advisories. If you just want to get an audit for a package tree, probably what you want to use is <code>arborist.audit()</code>.</p>
<h1><a class="anchor" id="autotoc_md15407"></a>
USAGE</h1>
<div class="fragment"><div class="line">const Calculator = require(&#39;@npmcli/metavuln-calculator&#39;)</div>
<div class="line">// pass in any options for cacache and pacote</div>
<div class="line">// see those modules for option descriptions</div>
<div class="line">const calculator = new Calculator(options)</div>
<div class="line"> </div>
<div class="line">// get an advisory somehow, typically by POSTing a JSON payload like:</div>
<div class="line">// {&quot;pkgname&quot;:[&quot;1.2.3&quot;,&quot;4.3.5&quot;, ...versions], ...packages}</div>
<div class="line">// to /-/npm/v1/security/advisories/bulk</div>
<div class="line">// to get a payload response like:</div>
<div class="line">// {</div>
<div class="line">//   &quot;semver&quot;: [</div>
<div class="line">//     {</div>
<div class="line">//       &quot;id&quot;: 31,</div>
<div class="line">//       &quot;url&quot;: &quot;https://npmjs.com/advisories/31&quot;,</div>
<div class="line">//       &quot;title&quot;: &quot;Regular Expression Denial of Service&quot;,</div>
<div class="line">//       &quot;severity&quot;: &quot;moderate&quot;,</div>
<div class="line">//       &quot;vulnerable_versions&quot;: &quot;&lt;4.3.2&quot;</div>
<div class="line">//     }</div>
<div class="line">//   ],</div>
<div class="line">//   ...advisories</div>
<div class="line">// }</div>
<div class="line">const arb = new Aborist(options)</div>
<div class="line">const tree = await arb.loadActual()</div>
<div class="line">const advisories = await getBulkAdvisoryReportSomehow(tree)</div>
<div class="line"> </div>
<div class="line">// then to get a comprehensive set of advisories including metavulns:</div>
<div class="line">const set = new Set()</div>
<div class="line">for (const [name, advisory] of Object.entries(advisories)) {</div>
<div class="line">  // make sure we have the advisories loaded with latest version lists</div>
<div class="line">  set.add(await calculator.calculate(name, {advisory}))</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">for (const vuln of set) {</div>
<div class="line">  for (const node of tree.inventory.query(&#39;name&#39;, vuln.name)) {</div>
<div class="line">    // not vulnerable, just keep looking</div>
<div class="line">    if (!vuln.testVersion(node.version))</div>
<div class="line">      continue</div>
<div class="line">    for (const { from: dep, spec } of node.edgesIn) {</div>
<div class="line">      const metaAdvisory = await calculator.calculate(dep.name, vuln)</div>
<div class="line">      if (metaAdvisory.testVersion(dep.version, spec)) {</div>
<div class="line">        set.add(metaAdvisory)</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md15408"></a>
API</h1>
<h2><a class="anchor" id="autotoc_md15409"></a>
Class: Advisory</h2>
<p class="">The <code>Calculator.calculate</code> method returns a Promise that resolves to a <code>Advisory</code> object, filled in from the cache and updated if necessary with the available advisory data.</p>
<p class="">Do not instantiate <code>Advisory</code> objects directly. Use the <code>calculate()</code> method to get one with appropriate data filled in.</p>
<p class="">Do not mutate <code>Advisory</code> objects. Use the supplied methods only.</p>
<h3><a class="anchor" id="autotoc_md15410"></a>
Fields</h3>
<ul>
<li><code>name</code> The name of the package that this vulnerability is about</li>
<li><code>id</code> The unique cache key for this vuln or metavuln. (See <b>Cache Keys</b> below.)</li>
<li><code>dependency</code> For metavulns, the dependency that causes this package to be have a vulnerability. For advisories, the same as <code>name</code>.</li>
<li><code>type</code> Either &lsquo;'advisory&rsquo;<code>or</code>'metavuln'`, depending on the type of vulnerability that this object represents.</li>
<li><code>url</code> The url for the advisory (<code>null</code> for metavulns)</li>
<li><code>title</code> The text title of the advisory or metavuln</li>
<li><code>severity</code> The severity level info/low/medium/high/critical</li>
<li><code>range</code> The range that is vulnerable</li>
<li><code>versions</code> The set of available versions of the package</li>
<li><code>vulnerableVersions</code> The set of versions that are vulnerable</li>
<li><code>source</code> The numeric ID of the advisory, or the cache key of the vulnerability that causes this metavuln</li>
<li><code>updated</code> Boolean indicating whether this vulnerability was updated since being read from cache.</li>
<li><code>packument</code> The packument object for the package that this vulnerability is about.</li>
</ul>
<h3><a class="anchor" id="autotoc_md15411"></a>
&lt;tt&gt;vuln.testVersion(version, [dependencySpecifier]) -&gt; Boolean&lt;/tt&gt;</h3>
<p class="">Check to see if a given version is vulnerable. Returns <code>true</code> if the version is vulnerable, and should be avoided.</p>
<p class="">For metavulns, <code>dependencySpecifier</code> indicates the version range of the source of the vulnerability, which the module depends on. If not provided, will attempt to read from the packument. If not provided, and unable to read from the packument, then <code>true</code> is returned, indicating that the (not installable) package version should be avoided.</p>
<h3><a class="anchor" id="autotoc_md15412"></a>
Cache Keys</h3>
<p class="">The cache keys are calculated by hashing together the <code>source</code> and <code>name</code> fields, prefixing with the string &lsquo;'security-advisory:&rsquo;` and the name of the dependency that is vulnerable.</p>
<p class="">So, a third-level metavulnerability might have a key like:</p>
<div class="fragment"><div class="line">&#39;security-advisory:foo:&#39;+ hash([&#39;foo&#39;, hash([&#39;bar&#39;, hash([&#39;baz&#39;, 123])])])</div>
</div><!-- fragment --><p class="">Thus, the cached entry with this key would reflect the version of <code>foo</code> that is vulnerable by virtue of dependending exclusively on versions of <code>bar</code> which are vulnerable by virtue of depending exclusively on versions of <code>baz</code> which are vulnerable by virtue of advisory ID <code>123</code>.</p>
<p class="">Loading advisory data entirely from cache without hitting an npm registry security advisory endpoint is not supported at this time, but technically possible, and likely to come in a future version of this library.</p>
<h2><a class="anchor" id="autotoc_md15413"></a>
&lt;tt&gt;calculator = new Calculator(options)&lt;/tt&gt;</h2>
<p class="">Options object is used for <code>cacache</code> and <code>pacote</code> calls.</p>
<h2><a class="anchor" id="autotoc_md15414"></a>
&lt;tt&gt;calculator.calculate(name, source)&lt;/tt&gt;</h2>
<ul>
<li><code>name</code> The name of the package that the advisory is about</li>
<li><code>source</code> Advisory object from the npm security endpoint, or a <code>Advisory</code> object returned by a previous call to the <code>calculate()</code> method. "Advisory" objects need to have:<ul>
<li><code>id</code> id of the advisory or Advisory object</li>
<li><code>vulnerable_versions</code> range of versions affected</li>
<li><code>url</code></li>
<li><code>title</code></li>
<li><code>severity</code></li>
</ul>
</li>
</ul>
<p class="">Fetches the packument and returns a Promise that resolves to a vulnerability object described above.</p>
<p class="">Will perform required I/O to fetch package metadata from registry and read from cache. Advisory information written back to cache.</p>
<h1><a class="anchor" id="autotoc_md15415"></a>
Dependent Version Sampling</h1>
<p class="">Typically, dependency ranges don't change very frequently, and the most recent version published on a given release line is most likely to contain the fix for a given vulnerability.</p>
<p class="">So, we see things like this:</p>
<div class="fragment"><div class="line">3.0.4 - not vulnerable</div>
<div class="line">3.0.3 - vulnerable</div>
<div class="line">3.0.2 - vulnerable</div>
<div class="line">3.0.1 - vulnerable</div>
<div class="line">3.0.0 - vulnerable</div>
<div class="line">2.3.107 - not vulnerable</div>
<div class="line">2.3.106 - not vulnerable</div>
<div class="line">2.3.105 - vulnerable</div>
<div class="line">... 523 more vulnerable versions ...</div>
<div class="line">2.0.0 - vulnerable</div>
<div class="line">1.1.102 - not vulnerable</div>
<div class="line">1.1.101 - vulnerable</div>
<div class="line">... 387 more vulnerable versions ...</div>
<div class="line">0.0.0 - vulnerable</div>
</div><!-- fragment --><p class="">In order to determine which versions of a package are affected by a vulnerability in a dependency, this module uses the following algorithm to minimize the number of tests required by performing a binary search on each version set, and presuming that versions <em>between</em> vulnerable versions within a given set are also vulnerable.</p>
<ol type="1">
<li>Sort list of available versions by SemVer precedence</li>
<li>Group versions into sets based on MAJOR/MINOR versions. <pre class="fragment">3.0.0 - 3.0.4
2.3.0 - 2.3.107
2.2.0 - 2.2.43
2.1.0 - 2.1.432
2.0.0 - 2.0.102
1.1.0 - 1.1.102
1.0.0 - 1.0.157
0.1.0 - 0.1.123
0.0.0 - 0.0.57
</pre></li>
<li>Test the highest and lowest in each MAJOR/MINOR set, and mark highest and lowest with known-vulnerable status. (<code>(s)</code> means "safe" and <code>(v)</code> means "vulnerable".) <pre class="fragment">3.0.0(v) - 3.0.4(s)
2.3.0(v) - 2.3.107(s)
2.2.0(v) - 2.2.43(v)
2.1.0(v) - 2.1.432(v)
2.0.0(v) - 2.0.102(v)
1.1.0(v) - 1.1.102(s)
1.0.0(v) - 1.0.157(v)
0.1.0(v) - 0.1.123(v)
0.0.0(v) - 0.0.57(v)
</pre></li>
<li>For each set of package versions:<ol type="a">
<li>If highest and lowest both vulnerable, assume entire set is vulnerable, and continue to next set. Ie, in the example, throw out the following version sets: <pre class="fragment">2.2.0(v) - 2.2.43(v)
2.1.0(v) - 2.1.432(v)
2.0.0(v) - 2.0.102(v)
1.0.0(v) - 1.0.157(v)
0.1.0(v) - 0.1.123(v)
0.0.0(v) - 0.0.57(v)
</pre></li>
<li>Test middle version MID in set, splitting into two sets. <pre class="fragment">3.0.0(v) - 3.0.2(v) - 3.0.4(s)
2.3.0(v) - 2.3.54(v) - 2.3.107(s)
1.1.0(v) - 1.1.51(v) - 1.1.102(s)
</pre></li>
<li>If any untested versions in Set(mid..highest) or Set(lowest..mid), add to list of sets to test. <pre class="fragment">3.0.0(v) - 3.0.2(v) &lt;-- thrown out on next iteration
3.0.2(v) - 3.0.4(s)
2.3.0(v) - 2.3.54(v) &lt;-- thrown out on next iteration
2.3.54(v) - 2.3.107(s)
1.1.0(v) - 1.1.51(v) &lt;-- thrown out on next iteration
1.1.51(v) - 1.1.102(s)
</pre> When the process finishes, all versions are either confirmed safe, or confirmed/assumed vulnerable, and we avoid checking large sets of versions where vulnerabilities went unfixed.</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md15416"></a>
Testing Version for MetaVuln Status</h2>
<p class="">When the dependency is in <code>bundleDependencies</code>, we treat any dependent version that <em>may</em> be vulnerable as a vulnerability. If the dependency is not in <code>bundleDependencies</code>, then we treat the dependent module as a vulnerability if it can <em>only</em> resolve to dependency versions that are vulnerable.</p>
<p class="">This relies on the reasonable assumption that the version of a bundled dependency will be within the stated dependency range, and accounts for the fact that we can't know ahead of time which version of a dependency may be bundled. So, we avoid versions that <em>may</em> bundle a vulnerable dependency.</p>
<p class="">For example:</p>
<p class="">Package <code>foo</code> depends on package <code>bar</code> at the following version ranges:</p>
<div class="fragment"><div class="line">foo version   bar version range</div>
<div class="line">1.0.0         ^1.2.3</div>
<div class="line">1.0.1         ^1.2.4</div>
<div class="line">1.0.2         ^1.2.5</div>
<div class="line">1.1.0         ^1.3.1</div>
<div class="line">1.1.1         ^1.3.2</div>
<div class="line">1.1.2         ^1.3.3</div>
<div class="line">2.0.0         ^2.0.0</div>
<div class="line">2.0.1         ^2.0.1</div>
<div class="line">2.0.2         ^2.0.2</div>
</div><!-- fragment --><p class="">There is an advisory for <code>bar@1.2.4 - 1.3.2</code>. So:</p>
<div class="fragment"><div class="line">foo version   vulnerable?</div>
<div class="line">1.0.0         if bundled (can use 1.2.3, which is not vulnerable)</div>
<div class="line">1.0.1         yes (must use ^1.2.4, entirely contained in vuln range)</div>
<div class="line">1.0.2         yes (must use ^1.2.5, entirely contained in vuln range)</div>
<div class="line">1.1.0         if bundled (can use 1.3.3, which is not vulnerable)</div>
<div class="line">1.1.1         if bundled (can use 1.3.3, which is not vulnerable)</div>
<div class="line">1.1.2         no (dep is outside of vuln range)</div>
<div class="line">2.0.0         no (dep is outside of vuln range)</div>
<div class="line">2.0.1         no (dep is outside of vuln range)</div>
<div class="line">2.0.2         no (dep is outside of vuln range)</div>
</div><!-- fragment --><p class="">To test a package version for metaVulnerable status, we attempt to load the manifest of the dependency, using the vulnerable version set as the <code>avoid</code> versions. If we end up selecting a version that should be avoided, then that means that the package is vulnerable by virtue of its dependency. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
