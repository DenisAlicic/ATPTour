Calculate meta-\/vulnerabilities from package security advisories

This is a pretty low-\/level package to abstract out the parts of \href{http://npm.im/@npmcli/arborist}{\texttt{ @npmcli/arborist}} that calculate metavulnerabilities from security advisories. If you just want to get an audit for a package tree, probably what you want to use is {\ttfamily arborist.\+audit()}.\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15407}{}\doxysection{USAGE}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15407}

\begin{DoxyCode}{0}
\DoxyCodeLine{const Calculator = require('@npmcli/metavuln-\/calculator')}
\DoxyCodeLine{// pass in any options for cacache and pacote}
\DoxyCodeLine{// see those modules for option descriptions}
\DoxyCodeLine{const calculator = new Calculator(options)}
\DoxyCodeLine{}
\DoxyCodeLine{// get an advisory somehow, typically by POSTing a JSON payload like:}
\DoxyCodeLine{// \{"{}pkgname"{}:["{}1.2.3"{},"{}4.3.5"{}, ...versions], ...packages\}}
\DoxyCodeLine{// to /-\//npm/v1/security/advisories/bulk}
\DoxyCodeLine{// to get a payload response like:}
\DoxyCodeLine{// \{}
\DoxyCodeLine{//   "{}semver"{}: [}
\DoxyCodeLine{//     \{}
\DoxyCodeLine{//       "{}id"{}: 31,}
\DoxyCodeLine{//       "{}url"{}: "{}https://npmjs.com/advisories/31"{},}
\DoxyCodeLine{//       "{}title"{}: "{}Regular Expression Denial of Service"{},}
\DoxyCodeLine{//       "{}severity"{}: "{}moderate"{},}
\DoxyCodeLine{//       "{}vulnerable\_versions"{}: "{}<4.3.2"{}}
\DoxyCodeLine{//     \}}
\DoxyCodeLine{//   ],}
\DoxyCodeLine{//   ...advisories}
\DoxyCodeLine{// \}}
\DoxyCodeLine{const arb = new Aborist(options)}
\DoxyCodeLine{const tree = await arb.loadActual()}
\DoxyCodeLine{const advisories = await getBulkAdvisoryReportSomehow(tree)}
\DoxyCodeLine{}
\DoxyCodeLine{// then to get a comprehensive set of advisories including metavulns:}
\DoxyCodeLine{const set = new Set()}
\DoxyCodeLine{for (const [name, advisory] of Object.entries(advisories)) \{}
\DoxyCodeLine{  // make sure we have the advisories loaded with latest version lists}
\DoxyCodeLine{  set.add(await calculator.calculate(name, \{advisory\}))}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{for (const vuln of set) \{}
\DoxyCodeLine{  for (const node of tree.inventory.query('name', vuln.name)) \{}
\DoxyCodeLine{    // not vulnerable, just keep looking}
\DoxyCodeLine{    if (!vuln.testVersion(node.version))}
\DoxyCodeLine{      continue}
\DoxyCodeLine{    for (const \{ from: dep, spec \} of node.edgesIn) \{}
\DoxyCodeLine{      const metaAdvisory = await calculator.calculate(dep.name, vuln)}
\DoxyCodeLine{      if (metaAdvisory.testVersion(dep.version, spec)) \{}
\DoxyCodeLine{        set.add(metaAdvisory)}
\DoxyCodeLine{      \}}
\DoxyCodeLine{    \}}
\DoxyCodeLine{  \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15408}{}\doxysection{API}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15408}
\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15409}{}\doxysubsection{Class\+: Advisory}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15409}
The {\ttfamily Calculator.\+calculate} method returns a Promise that resolves to a {\ttfamily Advisory} object, filled in from the cache and updated if necessary with the available advisory data.

Do not instantiate {\ttfamily Advisory} objects directly. Use the {\ttfamily calculate()} method to get one with appropriate data filled in.

Do not mutate {\ttfamily Advisory} objects. Use the supplied methods only.\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15410}{}\doxysubsubsection{Fields}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15410}

\begin{DoxyItemize}
\item {\ttfamily name} The name of the package that this vulnerability is about
\item {\ttfamily id} The unique cache key for this vuln or metavuln. (See {\bfseries{Cache Keys}} below.)
\item {\ttfamily dependency} For metavulns, the dependency that causes this package to be have a vulnerability. For advisories, the same as {\ttfamily name}.
\item {\ttfamily type} Either `\textquotesingle{}advisory'{\ttfamily or}\textquotesingle{}metavuln\textquotesingle{}\`{}, depending on the type of vulnerability that this object represents.
\item {\ttfamily url} The url for the advisory ({\ttfamily null} for metavulns)
\item {\ttfamily title} The text title of the advisory or metavuln
\item {\ttfamily severity} The severity level info/low/medium/high/critical
\item {\ttfamily range} The range that is vulnerable
\item {\ttfamily versions} The set of available versions of the package
\item {\ttfamily vulnerable\+Versions} The set of versions that are vulnerable
\item {\ttfamily source} The numeric ID of the advisory, or the cache key of the vulnerability that causes this metavuln
\item {\ttfamily updated} Boolean indicating whether this vulnerability was updated since being read from cache.
\item {\ttfamily packument} The packument object for the package that this vulnerability is about.
\end{DoxyItemize}\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15411}{}\doxysubsubsection{$<$tt$>$vuln.\+test\+Version(version, \mbox{[}dependency\+Specifier\mbox{]}) -\/$>$ Boolean$<$/tt$>$}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15411}
Check to see if a given version is vulnerable. Returns {\ttfamily true} if the version is vulnerable, and should be avoided.

For metavulns, {\ttfamily dependency\+Specifier} indicates the version range of the source of the vulnerability, which the module depends on. If not provided, will attempt to read from the packument. If not provided, and unable to read from the packument, then {\ttfamily true} is returned, indicating that the (not installable) package version should be avoided.\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15412}{}\doxysubsubsection{Cache Keys}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15412}
The cache keys are calculated by hashing together the {\ttfamily source} and {\ttfamily name} fields, prefixing with the string `\textquotesingle{}security-\/advisory\+:'\`{} and the name of the dependency that is vulnerable.

So, a third-\/level metavulnerability might have a key like\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{'security-\/advisory:foo:'+ hash(['foo', hash(['bar', hash(['baz', 123])])])}

\end{DoxyCode}


Thus, the cached entry with this key would reflect the version of {\ttfamily foo} that is vulnerable by virtue of dependending exclusively on versions of {\ttfamily bar} which are vulnerable by virtue of depending exclusively on versions of {\ttfamily baz} which are vulnerable by virtue of advisory ID {\ttfamily 123}.

Loading advisory data entirely from cache without hitting an npm registry security advisory endpoint is not supported at this time, but technically possible, and likely to come in a future version of this library.\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15413}{}\doxysubsection{$<$tt$>$calculator = new Calculator(options)$<$/tt$>$}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15413}
Options object is used for {\ttfamily cacache} and {\ttfamily pacote} calls.\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15414}{}\doxysubsection{$<$tt$>$calculator.\+calculate(name, source)$<$/tt$>$}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15414}

\begin{DoxyItemize}
\item {\ttfamily name} The name of the package that the advisory is about
\item {\ttfamily source} Advisory object from the npm security endpoint, or a {\ttfamily Advisory} object returned by a previous call to the {\ttfamily calculate()} method. \char`\"{}\+Advisory\char`\"{} objects need to have\+:
\begin{DoxyItemize}
\item {\ttfamily id} id of the advisory or Advisory object
\item {\ttfamily vulnerable\+\_\+versions} range of versions affected
\item {\ttfamily url}
\item {\ttfamily title}
\item {\ttfamily severity}
\end{DoxyItemize}
\end{DoxyItemize}

Fetches the packument and returns a Promise that resolves to a vulnerability object described above.

Will perform required I/O to fetch package metadata from registry and read from cache. Advisory information written back to cache.\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15415}{}\doxysection{Dependent Version Sampling}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15415}
Typically, dependency ranges don\textquotesingle{}t change very frequently, and the most recent version published on a given release line is most likely to contain the fix for a given vulnerability.

So, we see things like this\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{3.0.4 -\/ not vulnerable}
\DoxyCodeLine{3.0.3 -\/ vulnerable}
\DoxyCodeLine{3.0.2 -\/ vulnerable}
\DoxyCodeLine{3.0.1 -\/ vulnerable}
\DoxyCodeLine{3.0.0 -\/ vulnerable}
\DoxyCodeLine{2.3.107 -\/ not vulnerable}
\DoxyCodeLine{2.3.106 -\/ not vulnerable}
\DoxyCodeLine{2.3.105 -\/ vulnerable}
\DoxyCodeLine{... 523 more vulnerable versions ...}
\DoxyCodeLine{2.0.0 -\/ vulnerable}
\DoxyCodeLine{1.1.102 -\/ not vulnerable}
\DoxyCodeLine{1.1.101 -\/ vulnerable}
\DoxyCodeLine{... 387 more vulnerable versions ...}
\DoxyCodeLine{0.0.0 -\/ vulnerable}

\end{DoxyCode}


In order to determine which versions of a package are affected by a vulnerability in a dependency, this module uses the following algorithm to minimize the number of tests required by performing a binary search on each version set, and presuming that versions {\itshape between} vulnerable versions within a given set are also vulnerable.


\begin{DoxyEnumerate}
\item Sort list of available versions by Sem\+Ver precedence
\item Group versions into sets based on MAJOR/\+MINOR versions. \begin{DoxyVerb}3.0.0 - 3.0.4
2.3.0 - 2.3.107
2.2.0 - 2.2.43
2.1.0 - 2.1.432
2.0.0 - 2.0.102
1.1.0 - 1.1.102
1.0.0 - 1.0.157
0.1.0 - 0.1.123
0.0.0 - 0.0.57
\end{DoxyVerb}

\item Test the highest and lowest in each MAJOR/\+MINOR set, and mark highest and lowest with known-\/vulnerable status. ({\ttfamily (s)} means \char`\"{}safe\char`\"{} and {\ttfamily (v)} means \char`\"{}vulnerable\char`\"{}.) \begin{DoxyVerb}3.0.0(v) - 3.0.4(s)
2.3.0(v) - 2.3.107(s)
2.2.0(v) - 2.2.43(v)
2.1.0(v) - 2.1.432(v)
2.0.0(v) - 2.0.102(v)
1.1.0(v) - 1.1.102(s)
1.0.0(v) - 1.0.157(v)
0.1.0(v) - 0.1.123(v)
0.0.0(v) - 0.0.57(v)
\end{DoxyVerb}

\item For each set of package versions\+:
\begin{DoxyEnumerate}
\item If highest and lowest both vulnerable, assume entire set is vulnerable, and continue to next set. Ie, in the example, throw out the following version sets\+: \begin{DoxyVerb}2.2.0(v) - 2.2.43(v)
2.1.0(v) - 2.1.432(v)
2.0.0(v) - 2.0.102(v)
1.0.0(v) - 1.0.157(v)
0.1.0(v) - 0.1.123(v)
0.0.0(v) - 0.0.57(v)
\end{DoxyVerb}

\item Test middle version MID in set, splitting into two sets. \begin{DoxyVerb}3.0.0(v) - 3.0.2(v) - 3.0.4(s)
2.3.0(v) - 2.3.54(v) - 2.3.107(s)
1.1.0(v) - 1.1.51(v) - 1.1.102(s)
\end{DoxyVerb}

\item If any untested versions in Set(mid..highest) or Set(lowest..mid), add to list of sets to test. \begin{DoxyVerb}3.0.0(v) - 3.0.2(v) <-- thrown out on next iteration
3.0.2(v) - 3.0.4(s)
2.3.0(v) - 2.3.54(v) <-- thrown out on next iteration
2.3.54(v) - 2.3.107(s)
1.1.0(v) - 1.1.51(v) <-- thrown out on next iteration
1.1.51(v) - 1.1.102(s)
\end{DoxyVerb}
 When the process finishes, all versions are either confirmed safe, or confirmed/assumed vulnerable, and we avoid checking large sets of versions where vulnerabilities went unfixed.
\end{DoxyEnumerate}
\end{DoxyEnumerate}\hypertarget{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15416}{}\doxysubsection{Testing Version for Meta\+Vuln Status}\label{md__home_denis_Documents_Faks_master_RS2_TennisAssociation_TennisAssociation_Client_node_modulesd365899a50787ee538183898a85d5b11_autotoc_md15416}
When the dependency is in {\ttfamily bundle\+Dependencies}, we treat any dependent version that {\itshape may} be vulnerable as a vulnerability. If the dependency is not in {\ttfamily bundle\+Dependencies}, then we treat the dependent module as a vulnerability if it can {\itshape only} resolve to dependency versions that are vulnerable.

This relies on the reasonable assumption that the version of a bundled dependency will be within the stated dependency range, and accounts for the fact that we can\textquotesingle{}t know ahead of time which version of a dependency may be bundled. So, we avoid versions that {\itshape may} bundle a vulnerable dependency.

For example\+:

Package {\ttfamily foo} depends on package {\ttfamily bar} at the following version ranges\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{foo version   bar version range}
\DoxyCodeLine{1.0.0         \string^1.2.3}
\DoxyCodeLine{1.0.1         \string^1.2.4}
\DoxyCodeLine{1.0.2         \string^1.2.5}
\DoxyCodeLine{1.1.0         \string^1.3.1}
\DoxyCodeLine{1.1.1         \string^1.3.2}
\DoxyCodeLine{1.1.2         \string^1.3.3}
\DoxyCodeLine{2.0.0         \string^2.0.0}
\DoxyCodeLine{2.0.1         \string^2.0.1}
\DoxyCodeLine{2.0.2         \string^2.0.2}

\end{DoxyCode}


There is an advisory for {\ttfamily bar@1.\+2.\+4 -\/ 1.\+3.\+2}. So\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{foo version   vulnerable?}
\DoxyCodeLine{1.0.0         if bundled (can use 1.2.3, which is not vulnerable)}
\DoxyCodeLine{1.0.1         yes (must use \string^1.2.4, entirely contained in vuln range)}
\DoxyCodeLine{1.0.2         yes (must use \string^1.2.5, entirely contained in vuln range)}
\DoxyCodeLine{1.1.0         if bundled (can use 1.3.3, which is not vulnerable)}
\DoxyCodeLine{1.1.1         if bundled (can use 1.3.3, which is not vulnerable)}
\DoxyCodeLine{1.1.2         no (dep is outside of vuln range)}
\DoxyCodeLine{2.0.0         no (dep is outside of vuln range)}
\DoxyCodeLine{2.0.1         no (dep is outside of vuln range)}
\DoxyCodeLine{2.0.2         no (dep is outside of vuln range)}

\end{DoxyCode}


To test a package version for meta\+Vulnerable status, we attempt to load the manifest of the dependency, using the vulnerable version set as the {\ttfamily avoid} versions. If we end up selecting a version that should be avoided, then that means that the package is vulnerable by virtue of its dependency. 